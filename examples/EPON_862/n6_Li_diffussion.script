# LAMMPS generalized input script for using create_atoms. The force field section will be
# intialized from the style hints that may or may not be in the read-in files (if not N/As
# will be written and will have to be updated. Generalized LAMMPS input script generated by
# bond_react_merge.py v1.17 / 14 April 2025.

# Please look over the script carefully and adjust what is needed. You may also go into
# src/bond_react_merge/lmp_inscript.py to update default information in this script (if
# desired).

#--------InputParameters---------

variable        replicate string 1
variable        system    string Graphite_AB_lithiation
variable        pseed     equal  12345
variable        ptemp     equal  300
variable        FF        string PCFF_IFF

variable        out_ps    equal  0.001#1     # thermo and restart output durations (ps - dump is 10x this value)
variable        nve_ps    equal  0.001#25    # nve/limit stabilization time (ps)
variable        npt_ps    equal  0.001#225   # npt relaxation time times (ps)
variable        diff_ps   equal  0.001#2000  # diffusion time (ps)

variable        dv        equal  3.0   # voltage between two parallel plates (volts)
variable        nx        equal  0     # normal vector in X-direction (sqrt[nx**2 + ny**2 + nz**2] != 1 as they will be renomarlized) 
variable        ny        equal  1     # normal vector in Y-direction (sqrt[nx**2 + ny**2 + nz**2] != 1 as they will be renomarlized)
variable        nz        equal  0     # normal vector in Z-direction (sqrt[nx**2 + ny**2 + nz**2] != 1 as they will be renomarlized)

variable        outputs   string diffusion_${nx}-${ny}-${nz}_dv_${dv}



#------------Initialization------------
units           real
dimension       3
boundary        p p p
newton          on


#------------Force Field------------
atom_style      full
bond_style      class2
angle_style     class2
dihedral_style  class2
improper_style  class2
special_bonds   lj/coul 0 0 1

kspace_style    pppm 1.0e-4
pair_style      lj/class2/coul/long 12.0
pair_modify     mix sixthpower

neighbor        6.0 bin
neigh_modify    delay 0 every 1 check yes one 100000 page 10000000

comm_style      brick
comm_modify     cutoff 22.0

# Read LAMMPS datafile and add room for the Li-ion parameters
read_data       relax_PCFF_IFF_Pitch_rep_1_Graphite_AB_lithiation_0.1.data

#------------Count number aromatic carbons------------
group           li_ions type li+
group           pi_electrons type cge

group           natoms_group subtract all li_ions pi_electrons
variable        natoms_count equal count(natoms_group)
variable        nli equal count(li_ions)

group           char subtract all li_ions pi_electrons

variable        x equal ${nli}/(${natoms_count}/6)
variable        myid string ${outputs}_Li_${nli}_x_${x}_seed_${pseed}_${FF}_Pitch_rep_${replicate}_${system}



#------------Settings------------
timestep        0.5
variable        Time equal step*dt/1000
variable        out_steps  equal round(1000*${out_ps}/dt)
variable        nve_steps  equal round(1000*${nve_ps}/dt)
variable        npt_steps  equal round(1000*${npt_ps}/dt)
variable        diff_steps equal round(1000*${diff_ps}/dt)


#------------Compute force to apply to Li-ion atoms------------
# Normalize the direction nx, ny, and nz components of force
variable        nmag equal sqrt(${nx}*${nx}+${ny}*${ny}+${nz}*${nz})
variable        mx   equal ${nx}/${nmag}
variable        my   equal ${ny}/${nmag}
variable        mz   equal ${nz}/${nmag}

# Compute length of box in given force direction and find distance between
# the simulated parallel plates to generate a uniform electric field
variable        dx   equal v_mx*lx
variable        dy   equal v_my*ly
variable        dz   equal v_mz*lz
variable        d    equal sqrt(v_dx*v_dx+v_dy*v_dy+v_dz*v_dz)

# Compute force based on uniform electric field
# https://opentextbc.ca/foundationsofphysics/chapter/uniform-electric-fields/
#   F_el = q*E
#    * F_el = Electronic force
#    * q = Charge in coulombs
#    * E = Electric field
#   E = V/d
#    * V = voltage between parallel plates
#    * d = Distance between parallel plates
#   F_el = q*(V/d) # with some unit handling
#
# LAMMPS Units
#    force = (kcal/mol)/Angstrom = 6.476948455983 x 10^-11 J/m (aka Newton)
variable        q_electron        equal 1.60217663e-19             # Coulombs
variable        efield_volt_ang   equal v_dv/v_d                   # Volts/angstrom
variable        efield_volt_met   equal v_efield_volt_ang/(1e-10)  # Volts/meter

variable        force_newtons     equal v_q_electron*v_efield_volt_met       # Newtons
variable        force_kcalmol_ang equal v_force_newtons/(6.476948455983e-11) # (kcal/mol)/Angstrom

variable        fx                equal v_mx*v_force_kcalmol_ang # (kcal/mol)/Angstrom
variable        fy                equal v_my*v_force_kcalmol_ang # (kcal/mol)/Angstrom
variable        fz                equal v_mz*v_force_kcalmol_ang # (kcal/mol)/Angstrom


#------------Thermosettings------------
thermo          ${out_steps}
thermo_style    custom step temp press density vol ke pe etotal ecouple econserve evdwl ecoul epair elong ebond eangle edihed eimp &
                xlo xhi ylo yhi zlo zhi lx ly lz v_nmag v_mx v_my v_mz v_dx v_dy v_dz v_d v_efield_volt_ang v_efield_volt_met &
                v_force_newtons v_force_kcalmol_ang v_fx v_fy v_fz v_natoms_count v_nli v_x v_Time
log             ${myid}.log.lammps
restart         ${out_steps} ${myid}.a.rst1 ${myid}.a.rst2


#------------Tether char in place------------
# Define box center (fixed point)
variable        tmp1 equal xlo
variable        tmp2 equal xhi
variable        tmp3 equal ylo
variable        tmp4 equal yhi
variable        tmp5 equal zlo
variable        tmp6 equal zhi
variable        y0   equal (${tmp1}+${tmp2})/2.0
variable        x0   equal (${tmp3}+${tmp4})/2.0
variable        z0   equal (${tmp5}+${tmp6})/2.0

# Compute center of mass of char
compute         com_char char com
run             0

# Find starting distance of COM of char to center of box
variable        tmp7  equal c_com_char[1]
variable        tmp8  equal c_com_char[2]
variable        tmp9  equal c_com_char[3]
variable        r0_dy equal ${tmp7}-${y0}
variable        r0_dx equal ${tmp8}-${x0}
variable        r0_dz equal ${tmp9}-${z0}
variable        r0    equal sqrt(v_r0_dx*v_r0_dx+v_r0_dy*v_r0_dy+v_r0_dz*v_r0_dz)
uncompute       com_char

# Apply spring force to COM of group mol to pull it to box center
variable        force_tether equal v_nli*v_force_kcalmol_ang/(1/100) # force/picometer
fix             tether char spring tether $(v_force_tether) ${x0} ${y0} ${z0} ${r0}

# Add r0 to therm output
thermo_style    custom step temp press density vol ke pe etotal ecouple econserve evdwl ecoul epair elong ebond eangle edihed eimp &
                xlo xhi ylo yhi zlo zhi lx ly lz v_nmag v_mx v_my v_mz v_dx v_dy v_dz v_d v_efield_volt_ang v_efield_volt_met &
                v_force_newtons v_force_kcalmol_ang v_fx v_fy v_fz v_natoms_count v_nli v_x v_x0 v_y0 v_z0 &
                v_r0_dx v_r0_dy v_r0_dz v_r0 v_Time


#------------Stabilize Ions------------
minimize        1.0e-4 1.0e-6 1000 100000
run             0
velocity        all create ${ptemp} ${pseed} dist gaussian

fix             1 all nve/limit 0.1
fix             2 all temp/rescale 1 ${ptemp} ${ptemp} 10 1
run             ${nve_steps}
write_data      ${myid}_stabilized.data
unfix           1
unfix           2


#------------Relax model------------
fix             1 all langevin ${ptemp} ${ptemp} $(100*dt) 4875321
fix             2 all nph aniso 1.0 1.0 $(1000*dt)

run             ${npt_steps}
write_data      ${myid}_relaxed.data
unfix           1
unfix           2


#------------Apply force to Li-ion atoms and compute MSD------------
fix             eforce  li_ions addforce v_fx v_fy v_fz every 1
compute         msd_org_li li_ions msd com no
compute         msd_com_li li_ions msd com yes
compute         msd_org_char char msd com no
compute         msd_com_char char msd com yes

variable        Diff_Time equal (v_Time-(v_nve_ps+v_npt_ps))*1e-12          # seconds
variable        Diff_Data equal (c_msd_com_li[4]/((2*3)*v_nli))*1e-16  # cm^2

thermo_style    custom step temp press density vol ke pe etotal ecouple econserve evdwl ecoul epair elong ebond eangle edihed eimp &
                xlo xhi ylo yhi zlo zhi lx ly lz v_nmag v_mx v_my v_mz v_dx v_dy v_dz v_d v_efield_volt_ang v_efield_volt_met &
                v_force_newtons v_force_kcalmol_ang v_fx v_fy v_fz v_natoms_count v_nli v_x v_x0 v_y0 v_z0 v_r0 &
                v_r0_dx v_r0_dy v_r0_dz v_r0 v_Time v_Diff_Time v_Diff_Data &
                c_msd_org_char[1] c_msd_org_char[2] c_msd_org_char[3] c_msd_org_char[4] &
                c_msd_com_char[1] c_msd_com_char[2] c_msd_com_char[3] c_msd_com_char[4] &
                c_msd_org_li[1] c_msd_org_li[2] c_msd_org_li[3] c_msd_org_li[4] &
                c_msd_com_li[1] c_msd_com_li[2] c_msd_com_li[3] c_msd_com_li[4] &
                f_tether[1] f_tether[2] f_tether[3] f_tether[4]

#------------Dumpsettings------------
dump            1 all custom $(10*v_out_steps) ${myid}.dump id type x y z fx fy fz ix iy iz vx vy vz xu yu zu mass # every 10*${${out_steps}}
dump_modify     1 pbc yes # ensure atom postions in dump are within the simulation cell


#------------Let Li-ions diffuse in model------------
fix             1 all langevin ${ptemp} ${ptemp} $(100*dt) 4875321
fix             2 all nph aniso 1.0 1.0 $(1000*dt)

write_data      ${myid}_diffusion.data
run             ${diff_steps}
